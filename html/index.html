<html lang="ja">

<head>
	<meta charset="utf-8">

	<meta name="twitter:card" content="summary" />
	<meta name="twitter:site" content="@bluehood_admin" />
	<meta property="og:title" content="Troopa 👀" />
	<meta property="og:description" content="Web 上で作るおもちゃシンセサイザー。" />
	<!--<meta property="og:image" content="https://twiverse.net/etc/troopa/eyes.png" />-->

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-118660329-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'UA-118660329-1');
	</script>

	<title>Troopa 👀</title>

	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
		integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
	<script src="UUID.js/src/uuid.js"></script>
	<script src="leader-line/leader-line.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
	<script src="//twemoji.maxcdn.com/2/twemoji.min.js?11.3"></script>

	<script src="core.js"></script>
	<script src="ui.js"></script>
	<script src="com.js"></script>

	<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet'>
	<link href='style.css' rel='stylesheet'>
</head>

<body>
	<nav>
		<h1>Troopa</h1> <span style="font-size: large; ">👀</span>
		<h2>: Web おもちゃシンセサイザー。</h2>
		<span style="margin-left: 1em; ">
			<button id="btn-play">実行 <span style="color: hotpink; ">🔊</span></button>
			<span style="margin-left: 1em; ">
				<button id="btn-load">開く 📂</button>
				<button id="btn-save">保存 💾</button>
				<input id="filename" value="sample.syn" style="width: 96px; " placeholder="filename.syn">
			</span>
			<span style="margin-left: 1em; font-size: small; ">
				<a href="tutorial/" target="_blank"><button>チュートリアル 🔰</button></a>
				<a href="community/" target="_blank"><button>サンプル 🌐</button></a>
			</span>
		</span>
		<span style="float: right; margin-right: 2.5em; font-size: small; ">
			for Google Chrome on PC　　α 版
			<a href="about.html" target="_blank"><button>About ❓</button></a>
		</span>
	</nav>
	<aside>
	</aside>

	<script>
		var postRun = () => {
			var is_play = false;

			var sk = new Sketch();
			$("aside").css("margin-top", $("nav").outerHeight());
			var edit = new Editor($("body"), $("aside"), [
				Input,
				Keyboard,
				Sine,
				Square,
				Saw,
				Triangle,
				Noise,
				Buffer,
				Mixer,
				Subtractor,
				Amplifier,
				Divider,
				Integrator,
				Differentiator,
				UpperSaturator,
				LowerSaturator,
				Speaker,
				Meter,
				Scope,
				Repeater,
			], sk);

			{
				var file = JSON.parse('{"sketch":{"coms":[{"type":"Sine","id":"63c186b2-7337-44e5-96ea-a4ea8d6b2c3a","ins":[{"id":"38b207c5-38d3-4786-b866-72a7b91101fd","isint":false}],"outs":[{"tos":["e96b3686-b665-4b65-b08e-19a1c62eadb2"],"isint":false}]},{"type":"Speaker","id":"1c1e2194-65a6-4afd-82e5-8fb6482f0133","ins":[{"id":"e96b3686-b665-4b65-b08e-19a1c62eadb2","isint":false}],"outs":[{"tos":["77a8677b-2d63-4f1a-8736-839cdb104ca7"],"isint":false}]},{"type":"Input","id":"9649b56d-6e77-4ace-8213-0fc7b4522d57","ins":[],"outs":[{"tos":["38b207c5-38d3-4786-b866-72a7b91101fd"],"isint":false}]},{"type":"Scope","id":"eb3b15a4-e97c-410a-b372-f08cedf94e35","ins":[{"id":"77a8677b-2d63-4f1a-8736-839cdb104ca7","isint":false}],"outs":[{"tos":[],"isint":false}]}]},"ui":{"uicoms":[{"com_id":"63c186b2-7337-44e5-96ea-a4ea8d6b2c3a","x":339,"y":84,"name":"Sine","isrev":false},{"com_id":"1c1e2194-65a6-4afd-82e5-8fb6482f0133","x":542,"y":84,"name":"Speaker","isrev":false},{"com_id":"9649b56d-6e77-4ace-8213-0fc7b4522d57","x":143,"y":84,"name":"Input","isrev":false,"value":440},{"com_id":"eb3b15a4-e97c-410a-b372-f08cedf94e35","x":757.125,"y":84,"name":"Scope","isrev":false,"mode":1,"trig":0,"skip":1}]}}');
				var lut = sk.import(file.sketch);
				edit.import(file.ui, lut);
			}

			var ctx;
			var scproc;
			window.AudioContext = window.AudioContext || window.webkitAudioContext;
			var simStart = () => {
				ctx = new AudioContext();
				scproc = ctx.createScriptProcessor(0, 0, 1);
				scproc.connect(ctx.destination);

				scproc.onaudioprocess = (e) => {
					var out = e.outputBuffer.getChannelData(0);
					var bufferPtr = Module._malloc(Float32Array.BYTES_PER_ELEMENT * out.length);
					try {
						var dt = 1.0 / e.outputBuffer.sampleRate;
						var errorCode = Module.ccall('onAudioProcess', 'number', ['number', 'number', 'number'], [dt, bufferPtr, out.length]);
						if (errorCode) {
							throw errorCode;	// ここでエラーコードをメッセージ変換する。
						}
						var buffer = new Float32Array(Module.HEAPF32.buffer, bufferPtr, out.length);
						buffer.forEach((data, i) => {
							out[i] = data;
						});
					} catch (e) {
						alert(e);
						Module.ccall('onSimEnd', null, null, null);
					} finally {
						Module._free(bufferPtr);
					}
				};

				Module.ccall('onSimStart', null, null, null);
				$("#btn-play").html('停止 <span style="color: hotpink; ">🔇</span>');
				$("nav").css("background-color", "mistyrose");
				twemoji.parse($("#btn-play")[0]);
			}

			var simEnd = () => {
				is_play = false;
				scproc.disconnect(ctx.destination);
				Module.ccall('onSimEnd', null, null, null);
				ctx.close();
				$("#btn-play").html('実行 <span style="color: hotpink; ">🔊</span>');
				$("nav").css("background-color", "white");
				twemoji.parse($("#btn-play")[0]);
			};

			$("#btn-play").click(() => {
				is_play ^= true;
				if (is_play) {
					simStart();
				} else {
					simEnd();
				}
			});

			$("#btn-load").click(() => {
				var input = document.createElement("input");
				input.type = "file";
				input.accept = ".syn";
				input.onchange = (e) => {
					var reader = new FileReader();
					reader.onloadend = (e) => {
						var file = JSON.parse(e.target.result);
						var lut = sk.import(file.sketch);
						edit.import(file.ui, lut);
					};
					reader.readAsText(e.target.files[0]);
					$("#filename").val(e.target.files[0].name);
				};
				input.click();
			});

			$("#btn-save").click(() => {
				var sketch_data = Module.ccall('export_', 'string', null, null);
				console.log(sketch_data);
				return;
				var file = {
					sketch: sketch_data,
					ui: edit.export()
				};
				var a = document.createElement("a");
				a.download = $("#filename").val();
				a.href = URL.createObjectURL(new Blob([JSON.stringify(file)], { type: "text/plain" }));
				a.click();
			});

			$(window).on("keydown", (e) => {
				if (e.key == "F5") {
					$("#btn-play").click();
					e.preventDefault();
				} else if (e.key == "o" && e.ctrlKey) {
					$("#btn-load").click();
					e.preventDefault();
				} else if (e.key == "s" && e.ctrlKey) {
					$("#btn-save").click();
					e.preventDefault();
				}
			});

			var url_param = new URLSearchParams(location.search);
			if (url_param.has("src")) {
				var src = url_param.get("src");
				$.get(src, {}, (data) => {
					var lut = sk.import(data.sketch);
					edit.import(data.ui, lut);
					$("#filename").val(src);
				}, "json")
					.fail(() => {
						alert("Couldn't load the Sketch file: " + src + ". ");
					});
			}

			$(window).on("beforeunload", (e) => {
				return true;
			});

		};
		var Module = { postRun: postRun };

		twemoji.parse(document.body);
	</script>
	<script src="module.js"></script>
</body>

</html>